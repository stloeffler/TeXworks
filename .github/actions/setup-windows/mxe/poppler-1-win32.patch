This file is part of MXE. See LICENSE.md for licensing information.

Contains ad hoc patches for cross building.

From fb706071bff53f1dfb5e43aa4c102104d20846fe Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Stefan=20L=C3=B6ffler?= <st.loeffler@gmail.com>
Date: Sat, 26 Jun 2021 19:49:25 +0200
Subject: [PATCH 1/3] Fix retrieval of local (data) dir

---
 poppler/GlobalParams.cc | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/poppler/GlobalParams.cc b/poppler/GlobalParams.cc
index e054bc43..f3893bc9 100644
--- a/poppler/GlobalParams.cc
+++ b/poppler/GlobalParams.cc
@@ -122,11 +122,11 @@ BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
 }
 }
 
-static void get_poppler_localdir(char *retval, const char *suffix)
+static void get_poppler_localdir(char *retval, const int N, const char *suffix)
 {
     unsigned char *p;
 
-    if (!GetModuleFileNameA(hmodule, (CHAR *)retval, sizeof(retval) - 20)) {
+    if (!GetModuleFileNameA(hmodule, (CHAR *)retval, N - strlen(suffix))) {
         strcpy(retval, POPPLER_DATADIR);
         return;
     }
@@ -149,7 +149,7 @@ static const char *get_poppler_datadir(void)
     if (beenhere)
         return retval;
 
-    get_poppler_localdir(retval, "\\share\\poppler");
+    get_poppler_localdir(retval, MAX_PATH, "\\share\\poppler");
 
     beenhere = true;
 
@@ -167,7 +167,7 @@ static const char *get_poppler_fontsdir(void)
     if (beenhere)
         return retval;
 
-    get_poppler_localdir(retval, "\\share\\fonts");
+    get_poppler_localdir(retval, MAX_PATH, "\\share\\fonts");
 
     beenhere = true;
 
-- 
2.32.0


From 60bd7c1910bb03e3c8a709f32f7ebfd67885e04f Mon Sep 17 00:00:00 2001
From: Boris Nagaev <bnagaev@gmail.com>
Date: Wed, 27 Jul 2016 10:29:52 +0200
Subject: [PATCH 2/3] do not try to use mman.h (package mman-win32)

fix https://github.com/mxe/mxe/issues/1455
---
 poppler/CairoFontEngine.cc | 7 -------
 1 file changed, 7 deletions(-)

diff --git a/poppler/CairoFontEngine.cc b/poppler/CairoFontEngine.cc
index 4d98d0f2..bed79729 100644
--- a/poppler/CairoFontEngine.cc
+++ b/poppler/CairoFontEngine.cc
@@ -53,13 +53,6 @@
 #include "Gfx.h"
 #include "Page.h"
 
-#if defined(HAVE_FCNTL_H) && defined(HAVE_SYS_MMAN_H) && defined(HAVE_SYS_STAT_H)
-#    include <fcntl.h>
-#    include <sys/stat.h>
-#    include <sys/mman.h>
-#    define CAN_CHECK_OPEN_FACES 1
-#endif
-
 //------------------------------------------------------------------------
 // CairoFont
 //------------------------------------------------------------------------
-- 
2.32.0


From cbbf3edac2534f8c257c956830804ff1b3765792 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Stefan=20L=C3=B6ffler?= <st.loeffler@gmail.com>
Date: Thu, 4 Feb 2021 20:44:30 +0100
Subject: [PATCH 3/3] Fix static linking for libopenjpeg >= 2.4

---
 CMakeLists.txt | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9a0dcb15..87e00ac8 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -285,6 +285,9 @@ else()
   message(FATAL_ERROR "Invalid ENABLE_LIBOPENJPEG value: ${ENABLE_LIBOPENJPEG}")
 endif()
 set(ENABLE_LIBOPENJPEG "${WITH_OPENJPEG}")
+if(ENABLE_LIBOPENJPEG AND NOT BUILD_SHARED_LIBS)
+  add_definitions(-DOPJ_STATIC)
+endif()
 if(ENABLE_CMS STREQUAL "lcms2")
   find_package(LCMS2)
   set(USE_CMS ${LCMS2_FOUND})
-- 
2.32.0

